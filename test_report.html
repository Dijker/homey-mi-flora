<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="https://cdn.athom.com/athom-api/2.1.142/athom-api.min.js"></script>
    <script>


        /**
         * @private
         *
         * @param document
         * @param deviceDisplay
         *
         * @return string
         *
         */
        /*
        function _generateHtml(document, deviceDisplay) {

            let borderColor = '';
            let color = '';
            let colorBackgroundColor = '#f7f5f5';
            let colorGreen = '#d3fec4';
            let borderColorGreen = '#b3e0a2';
            let colorRed = '#ffd3cb';
            let borderColorRed = '#dd958f';
            let borderColorDefault = '#e6e6e6';
            let textColor = '#9c9c9c';
            let borderTable = '#c6c6c6';
            let textColorSecondary = '#c7c7c7';

            let widthDefault = 200;
            let heightDefault = 25;

            let flowerTable = document;
            let td = document;
            let tr = document;
            let loader = document;
            let loaderTr = document;
            let loaderTd = document;
            let title = document;

            const target = document.createElement("div");
            target.style.fontFamily = 'sans-serif';

            flowerTable = document.createElement("table");
            flowerTable.cellPadding = 0;
            flowerTable.cellSpacing = 0;
            flowerTable.style.marginTop = '1em';
            flowerTable.style.marginBottom = '1em';

            tr = document.createElement("tr");
            td = document.createElement("td");
            td.style.height = heightDefault + "px";
            td.style.textAlign = 'center';
            td.colSpan = 5;
            title = document.createElement("span");
            title.style.fontFamily = 'sans-serif';
            title.style.fontSize = '1em';
            title.style.color = textColor;
            moment.locale('nl')
            let momentDate = moment(new Date(Date.parse(deviceDisplay.lastUpdate)));
            title.innerHTML = deviceDisplay.name + ' (' + momentDate.fromNow() + ')';
            td.appendChild(title);
            tr.appendChild(td);
            flowerTable.appendChild(tr);

            let trThreshold = document.createElement("tr");
            let tdThreshold = document;
            for (let i = 1; i <= 4; i++) {
                // threshold tr
                tdThreshold = document.createElement("td");
                tdThreshold.style.height = "6px";
                if (i === 2) {
                    tdThreshold.style.borderLeft = '1px solid ' + borderTable;
                }
                trThreshold.appendChild(tdThreshold);
            }

            for (const capabilityName in deviceDisplay.capabilities) {

                const capability = deviceDisplay.capabilities[capabilityName];

                const min = capability.min;
                const max = capability.max;
                let value = capability.value;

                const start = min - (max - min);
                const end = max + (max - min);

                const parts = [
                    {
                        min: start,
                        max: min
                    },
                    {
                        min: min,
                        max: max
                    },
                    {
                        min: max,
                        max: end
                    }
                ];

                color = colorRed;
                borderColor = borderColorRed;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.min <= value && part.max >= value && i === 1) {
                        color = colorGreen;
                        borderColor = borderColorGreen;
                    }
                }
                let loaderDone = false;

                tr = document.createElement("tr");
                td = document.createElement("td");
                td.style.height = heightDefault + "px";
                td.colspan = 5;
                title = document.createElement("span");
                title.innerHTML = capability.sensor;
                title.style.margin = '0 5px 0 0';
                title.style.fontSize = '14px';
                title.style.fontFamily = 'sans-serif';
                title.style.color = textColor;
                td.appendChild(title);
                tr.appendChild(td);

                let trBuffer = document.createElement("tr");
                // add title
                let tdBuffer = document.createElement("td");
                trBuffer.appendChild(tdBuffer);

                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];

                    td = document.createElement("td");
                    td.style.whiteSpace = 'nowrap';
                    loader = document.createElement("table");
                    loader.cellPadding = 0;
                    loader.cellSpacing = 0;
                    loader.classList.add('loader');
                    loaderTr = document.createElement("tr");
                    loaderTd = document.createElement("td");
                    loaderTd.style.width = widthDefault + "px";
                    loaderTd.style.height = heightDefault + "px";

                    if (i === 0) {
                        td.style.borderLeft = '1px solid ' + borderTable;
                    }

                    loaderTd.style.backgroundColor = color;

                    // min = 125
                    // max = 175
                    // value = 150
                    // length = 175 - 125 = 50;
                    // offset - 175 - 150 = 25;
                    // percent = 100 / (50 / 25) = 50%
                    // width = 300 / 100 * 50 = 150px
                    let length = part.max - part.min;
                    let offset = part.max - value;
                    let percent = 100 / (length / offset);
                    loaderTd.style.textAlign = 'right';

                    title = document.createElement("span");
                    //title.innerHTML = value + Homey.__('capability.' + capability + '.suffix');
                    title.innerHTML = value + capability.suffix;
                    title.style.lineHeight = heightDefault + "px";
                    title.style.margin = '0 5px';
                    title.style.fontSize = '12px';
                    title.style.fontFamily = 'sans-serif';
                    title.style.color = textColor;

                    if (false === loaderDone) {
                        td.appendChild(loader);
                    }

                    // buffer tr
                    let tdBuffer = document.createElement("td");
                    tdBuffer.style.lineHeight = "15px";

                    let thresholdValue = document.createElement("span");
                    thresholdValue.style.lineHeight = "15px";
                    thresholdValue.style.margin = '0 3px';
                    thresholdValue.style.fontSize = '12px';
                    thresholdValue.style.fontFamily = 'sans-serif';

                    if (i === 0) {
                        tdBuffer.style.borderLeft = '1px solid ' + borderTable;
                    }
                    if (i === 0) {
                        tdBuffer.style.borderRight = '1px solid ' + borderColorDefault;
                        tdBuffer.style.textAlign = 'right';
                        thresholdValue.style.color = textColorSecondary;
                        thresholdValue.innerHTML = capability.min + capability.suffix;
                    }
                    if (i === 1) {
                        tdBuffer.style.borderRight = '1px solid ' + borderColorDefault;
                    }
                    if (i === 2) {
                        thresholdValue.style.color = textColorSecondary;
                        thresholdValue.innerHTML = capability.max + capability.suffix;
                        tdBuffer.style.textAlign = 'left';
                    }

                    tdBuffer.appendChild(thresholdValue);
                    trBuffer.appendChild(tdBuffer);

                    if (value <= part.min && i === 0) {
                        loaderTd.style.width = 0 + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    } else if (part.min < value && part.max >= value) {
                        loaderTd.style.width = widthDefault - (widthDefault / 100 * percent) - 1 + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    } else if (value > part.max && i === 2) {
                        loaderTd.style.width = widthDefault + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    }
                    loaderTr.appendChild(loaderTd);
                    loader.appendChild(loaderTr);

                    // min / max threshold
                    td.style.backgroundColor = colorBackgroundColor;
                    td.style.width = widthDefault + "px";
                    td.style.height = heightDefault + "px";
                    if (i !== 2) {
                        td.style.width = widthDefault - 1 + "px";
                        td.style.borderRight = '1px solid ' + borderColorDefault;
                    }
                    tr.appendChild(td);
                }

                flowerTable.appendChild(trThreshold.cloneNode(true));
                flowerTable.appendChild(trBuffer);
                flowerTable.appendChild(tr);
            }

            flowerTable.appendChild(trThreshold.cloneNode(true));

            tr = document.createElement("tr");
            td = document.createElement("td");
            tr.appendChild(td);
            td = document.createElement("td");
            td.style.borderBottom = '1px solid ' + borderTable;
            td.colSpan = 4;
            tr.appendChild(td);
            flowerTable.appendChild(tr);

            target.appendChild(flowerTable);
            target.style.backgroundColor = '#fbfbfb';

            return target.innerHTML;
        }
        */


        //Web-side
        //When using the CDN script include, all top-level exports are globally
        // available, so no includes are neccesarry.

        //When using a package manager such as npm or yarn and mjs and a transpiler,
        // we need to install athom-api and use the following import:
        //import {AthomCloudAPI, AthomStorageAdapter} from 'athom-api';

        //When using cjs and a transpiler we need to use the following import:
        //const {AthomCloudAPI, AthomStorageAdapter} = require('athom-api');


        //This sets a global config
        // Alternatively these values can be supplied to the constructor
        AthomCloudAPI.setConfig({
            clientId: "56d84892f8ea8fcd7952e70f",
            clientSecret: "JScLCb3WWTQGw9vHHejJSaup13ReWdYBsiH086Mh"
        });

        //Create a new AthomCloudAPI instance
        const cloudAPI = new AthomCloudAPI({
            //CloudAPI can use a store to persist and cache session data.
            // In this example we want to use HTML5 localStorage to do this.
            // Alternatively you can extend AthomStorageAdapter and implement
            //  your own storage engine instead.
            // If no store is specified, and HTML5 local storage is available,
            //  it is selected automatically.
            store: new AthomStorageAdapter.LocalStorage('_athom_cloud_api')
        });


        //This function attempts to log-in to a specific homey and returns a HomeyAPI
        async function login() {
            //Check if we are logged in
            if(!await cloudAPI.isLoggedIn()) {

                //If we are not logged in but do have an OAuth2 authorization code
                // parameter in our URL, use it to authenticate
                if(cloudAPI.hasAuthorizationCode()) {
                    await cloudAPI.authenticateWithAuthorizationCode();
                } else {
                    //Redirect the user to the OAuth2 login page
                    window.location.href = cloudAPI.getLoginUrl([
                        'account.homeys.readonly', //required to access homey
                        'homey.manager.flows.readonly' //required to read flows
                    ]);
                }
            }

            //Retrieve information about the currently logged in user
            //In some cases you may want to prefer a locally cached
            // version using getAuthenticatedUserCached.
            // Using a cached user is useful in situations where
            // internet connectivitity is not always available
            const user = await cloudAPI.getAuthenticatedUser();
            console.info('User', user.fullname, 'Authenticated');

            //Get the first homey of this user
            const homey = user.getFirstHomey();

            //Start a session on this Homey
            console.info('Logging in to:', homey.name);
            const homeyAPI = await homey.authenticate();

            console.info('homeyAPI created');

            //Example: Make the Homey say something to prove we're authenticated
            await homeyAPI.speechOutput.say({text: 'Hello: '+user.fullname});

            return homeyAPI;
        }

        login();


        // self executing function here
        document.addEventListener("DOMContentLoaded", function (event) {

            const deviceDisplay = {
                'name': 'Device name',
                'lastUpdate': new Date().toISOString(),
                'capabilities': {
                    'temperature': {
                        'sensor': 'temperature',
                        'min': 40,
                        'value': 2,
                        'max': 60,
                        'suffix': ' %'
                    },
                    'vochtigheid': {
                        'sensor': 'vochtigheid',
                        'min': 0,
                        'value': 500,
                        'max': 1000,
                        'suffix': ' %'
                    },
                    'voeding': {
                        'sensor': 'voeding',
                        'min': 20,
                        'value': 100,
                        'max': 30,
                        'suffix': ' %'
                    },
                    'licht': {
                        'sensor': 'licht',
                        'min': 20,
                        'value': 20,
                        'max': 30,
                        'suffix': ' %'
                    }
                }
            };

            const app = {
                rect(x, y, width, height, color) {
                    var rect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
                    rect.setAttributeNS(null, 'x', x);
                    rect.setAttributeNS(null, 'y', y);
                    rect.setAttributeNS(null, 'height', height);
                    rect.setAttributeNS(null, 'width', width);
                    rect.setAttributeNS(null, 'fill', color);

                    return rect;
                },
                render: function (deviceDisplay) {

                    // create the svg element
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                    // set width and height
                    svg.setAttribute("width", "1000px");
                    svg.setAttribute("height", "1000px");

                    let top = 100;
                    let left = 100;
                    const graphOffset = 80;
                    const width = 500;
                    const height = 30;
                    const textOffset = 5;
                    const lineOffset = 10;

                    for (const capabilityName in deviceDisplay.capabilities) {
                        const capability = deviceDisplay.capabilities[capabilityName];

                        top += graphOffset;
                        const minValue = capability.min;
                        const maxValue = capability.max;
                        const value = capability.value;

                        const startValue = minValue - (maxValue - minValue);
                        const endValue = maxValue + (maxValue - minValue);

                        const range = (endValue - startValue);

                        // start - min - value - max - end
                        //  20     40     50     60     80   (60)
                        //   0                         1000  (1000)
                        //   0            500          1000

                        // width = 1000

                        // minValue = 40
                        // maxValue = 60
                        // value = 50
                        // startValue = 20
                        // endValue = 80
                        // range = 60
                        //
                        // lengte = (50-20) = 30
                        // 1000 / (60 / 30)

                        console.log('--------------------');
                        console.log("width: " + width);
                        console.log("minValue: " + minValue);
                        console.log("maxValue: " + maxValue);
                        console.log("startValue: " + startValue);
                        console.log("endValue: " + endValue);
                        console.log("value: " + value);
                        console.log("range: " + range);
                        // 5000 600 1000
                        // 1000 / 5000 = 2
                        //
                        console.log("element value: " + this.percentage(value - startValue, range, width));
                        console.log("element min: " + this.percentage(minValue - startValue, range, width));
                        console.log("element max: " + this.percentage(maxValue - startValue, range, width));

                        // ctx.font = '12px serif';
                        // ctx.fillStyle = "grey";
                        // ctx.textAlign = "left";
                        // ctx.fillText(capabilityName, 0, top + (height / 2) + 3);

                        svg.appendChild(this.rect(
                            left,
                            top,
                            width,
                            height,
                            'red'
                        ));

                        svg.appendChild(this.rect(
                            left,
                            top,
                            this.percentage(value - startValue, range, width),
                            height,
                            'green'
                        ));

                        // ctx.font = '12px serif';
                        // ctx.fillStyle = "grey";
                        // ctx.textAlign = "right";
                        // ctx.fillText(" " + value + capability.suffix + " ", left + this.percentage(value - startValue, range, width), top + 20);

                        svg.appendChild(this.rect(
                            left + this.percentage(minValue - startValue, range, width),
                            top - textOffset,
                            1,
                            height + lineOffset,
                            'gray'
                        ));

                        // ctx.font = '12px serif';
                        // ctx.fillStyle = "grey";
                        // ctx.textAlign = "center";
                        // ctx.fillText(minValue + capability.suffix, left + this.percentage(minValue - startValue, range, width), top - (textOffset + lineOffset));

                        svg.appendChild(this.rect(
                            left + this.percentage(maxValue - startValue, range, width),
                            top - textOffset,
                            1,
                            height + lineOffset,
                            'gray'
                        ));

                        // ctx.font = '12px serif';
                        // ctx.fillStyle = "grey";
                        // ctx.textAlign = "center";
                        // ctx.fillText(maxValue + capability.suffix, left + this.percentage(maxValue - startValue, range, width), top - (textOffset + lineOffset));
                    }

                    return svg;
                },
                percentage: function (start, range, width) {
                    const value = (width / (range / start));
                    if (value > width) {
                        return width;
                    }
                    if (value < 0) {
                        return 50;
                    }
                    return value;
                }
            }

            document.getElementById('drawing').appendChild(app.render(deviceDisplay));
        });

    </script>
</head>
<body>
<div id="drawing"></div>
</body>
</html>