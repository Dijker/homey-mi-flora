<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <script>
        function buildHtmlChart(device) {

            const thresholdMapping = {
                'temperature': {
                    'min': 'temperature_min',
                    'max': 'temperature_max'
                }
            };
            const conditionsMapping = {
                'temperature': 'temperature_threshold'
            };

            const target = document.createElement("div");
            target.style.fontFamily = 'sans-serif';

            let borderColor = '';
            let color = '';
            let colorGreen = '#d3fec4';
            let borderColorGreen = '#b3e0a2';
            let colorRed = '#ffd3cb';
            let borderColorRed = '#dd958f';
            let colorDefault = '#fafafa';
            let borderColorDefault = '#ebebeb';
            let textColor = '#5c5c5c';
            let borderTable = '#434343';

            let widthDefault = 200;
            let heightDefault = 20;

            let flowerTable = document;
            let td = document;
            let tr = document;
            let loader = document;
            let loaderTr = document;
            let loaderTd = document;
            let title = document;

            flowerTable = document.createElement("table");
            flowerTable.cellPadding = 0;
            flowerTable.cellSpacing = 0;

            tr = document.createElement("tr");
            td = document.createElement("td");
            td.style.height = heightDefault + "px";
            td.colSpan = 5;
            title = document.createElement("span");
            title.style.fontFamily = 'sans-serif';
            title.style.fontSize = '1.5em';
            title.style.color = textColor;
            title.innerHTML = device.name;
            td.appendChild(title);
            tr.appendChild(td);
            flowerTable.appendChild(tr);

            let trBuffer = document.createElement("tr");
            let tdBuffer = document;
            for (let i = 1; i <= 4; i++) {
                // buffer tr
                tdBuffer = document.createElement("td");
                if (i !== 1 && i !== 4) {
                    tdBuffer.style.borderRight = '1px solid ' + borderColorDefault;
                }
                if (i === 2) {
                    tdBuffer.style.borderLeft = '1px solid ' + borderTable;
                }
                trBuffer.appendChild(tdBuffer);
            }
            flowerTable.appendChild(trBuffer.cloneNode(true));

            let trThreshold = document.createElement("tr");
            let tdThreshold = document;
            for (let i = 1; i <= 4; i++) {
                // threshold tr
                tdThreshold = document.createElement("td");
                tdThreshold.style.height = "10px";
                if (i !== 1 && i !== 4) {
                    tdThreshold.style.borderRight = '1px solid ' + borderColorDefault;
                }
                if (i === 2) {
                    tdThreshold.style.borderLeft = '1px solid ' + borderTable;
                }
                trThreshold.appendChild(tdThreshold);
            }
            flowerTable.appendChild(trThreshold.cloneNode(true));

            for (const capabilityName in device.capabilities) {

                const capability = device.capabilities[capabilityName];

                const min = capability.min;
                const max = capability.max;
                let value = capability.value;

                const start = min - (max - min);
                const end = max + (max - min);

                const parts = [
                    {
                        min: start,
                        max: min
                    },
                    {
                        min: min,
                        max: max
                    },
                    {
                        min: max,
                        max: end
                    }
                ];

                color = colorRed;
                borderColor = borderColorRed;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.min < value && part.max >= value && i === 1) {
                        color = colorGreen;
                        borderColor = borderColorGreen;
                    }
                }
                let loaderDone = false;

                tr = document.createElement("tr");
                td = document.createElement("td");
                td.style.height = heightDefault + "px";
                td.colspan = 5;
                td.style.width = "px";
                title = document.createElement("span");
                title.innerHTML = capabilityName;
                title.style.margin = '0 8px 0 0';
                title.style.fontSize = '0.7em';
                title.style.fontFamily = 'sans-serif';
                title.style.color = textColor;
                td.appendChild(title);
                tr.appendChild(td);

                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];

                    td = document.createElement("td");
                    td.style.whiteSpace = 'nowrap';
                    loader = document.createElement("table");
                    loader.cellPadding = 0;
                    loader.cellSpacing = 0;
                    loader.classList.add('loader');
                    loaderTr = document.createElement("tr");
                    loaderTd = document.createElement("td");
                    loaderTd.style.width = widthDefault + "px";
                    loaderTd.style.height = heightDefault + "px";

                    if (i === 0) {
                        td.style.borderLeft = '1px solid ' + borderTable;
                    }

                    loaderTd.style.backgroundColor = color;

                    // min = 125
                    // max = 175
                    // value = 150
                    // length = 175 - 125 = 50;
                    // offset - 175 - 150 = 25;
                    // percent = 100 / (50 / 25) = 50%
                    // width = 300 / 100 * 50 = 150px
                    let length = part.max - part.min;
                    let offset = part.max - value;
                    let percent = 100 / (length / offset);
                    loaderTd.style.textAlign = 'right';

                    title = document.createElement("span");
                    //title.innerHTML = value + Homey.__('capability.' + capability + '.suffix');
                    title.innerHTML = value;
                    title.style.lineHeight = heightDefault + "px";
                    title.style.margin = '0 3px';
                    title.style.fontSize = '0.7em';
                    title.style.fontFamily = 'sans-serif';
                    title.style.color = textColor;

                    if (false === loaderDone) {
                        td.appendChild(loader);
                    }

                    if (value <= part.min && i === 0) {
                        loaderTd.style.width = 0 + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    }
                    else if (part.min < value && part.max >= value) {
                        title.innerHTML = value;
                        loaderTd.style.width = widthDefault - (widthDefault / 100 * percent) - 1 + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    }
                    else if (value > part.max && i === 2) {
                        loaderTd.style.width = widthDefault + "px";
                        loaderTd.appendChild(title);
                        loaderTd.style.borderRight = '1px solid ' + borderColor;
                        loaderDone = true;
                    }
                    loaderTr.appendChild(loaderTd);
                    loader.appendChild(loaderTr);

                    // min / max threshold
                    td.style.backgroundColor = colorDefault;
                    td.style.width = widthDefault + "px";
                    td.style.height = heightDefault + "px";
                    if (i !== 2) {
                        td.style.width = widthDefault - 1 + "px";
                        td.style.borderRight = '1px solid ' + borderColorDefault;
                    }
                    tr.appendChild(td);
                }
                flowerTable.appendChild(tr);
                flowerTable.appendChild(trBuffer.cloneNode(true));
            }

            flowerTable.appendChild(trThreshold.cloneNode(true));
            target.appendChild(flowerTable);

            return target.innerHTML;
        }

        // self executing function here
        document.addEventListener("DOMContentLoaded", function (event) {

            const device = {
                'name': 'test',
                'capabilities': {
                    'temperature': {
                        'min': 20,
                        'max': 30,
                        'value': 25
                    },
                    'vochtigheid': {
                        'min': 20,
                        'max': 30,
                        'value': 5
                    },
                    'voeding': {
                        'min': 20,
                        'max': 30,
                        'value': 100
                    },
                    'licht': {
                        'min': 20,
                        'max': 30,
                        'value': 20
                    }
                }
            };

            capabilities = {};
            for (let x = 6; x < 43; x++) {
                capabilities['index ' + x] = {
                    'min': 200,
                    'max': 300,
                    'value': x * 10
                }
            }

            device['capabilities'] = capabilities;

            document.getElementById('target').innerHTML = buildHtmlChart(device);
        });

    </script>
    <title>Title</title>
</head>
<body>
<div id="target"></div>
</body>
</html>